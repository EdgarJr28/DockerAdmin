services:
  socket-proxy:
    image: tecnativa/docker-socket-proxy:latest
    container_name: socket-proxy
    environment:
      CONTAINERS: 1
      IMAGES: 1
      INFO: 1
      VERSION: 1
      PING: 1
      # Solo si en desarrollo vas a arrancar/parar contenedores:
      # POST: 1
      # ALLOW_START: 1
      # ALLOW_STOP: 1
      # ALLOW_RESTART: 1
      LOG_LEVEL: info
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    ports:
      - "127.0.0.1:2375:2375"  # ‚Üê Solo accesible desde el propio servidor
    restart: unless-stopped

  api:
    image: node:20-alpine
    working_dir: /app
    command: sh -c "npm ci && npm run start:dev"
    env_file:
      - ./api/.env
    environment:
      DOCKER_HOST: http://socket-proxy:2375
      PORT: 3001
      SCHEDULER_STORE: /data/scheduler.json
      TZ: America/Bogota
    volumes:
      - ./api:/app
    depends_on:
      - socket-proxy
    ports:
      - "3011:3001"
    restart: unless-stopped

  web:
    build:
      context: ./web
    environment:
      NODE_ENV: production
      PORT: 3010
    depends_on:
      - api
    ports:
      - "3010:3010"
    restart: unless-stopped
